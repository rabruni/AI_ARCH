# Design — Kernel (SPEC-004)

## 1) Kernel boundaries

The kernel is a “governed composition layer” that:
- keeps UX consistent
- selects stacks deterministically (released profiles only)
- enforces authority boundaries
- records auditable events

It is not:
- a task manager
- an executor
- a model-specific framework

## 2) Data types (deterministic shapes)

### PersonaProfile (versioned)

Fields:
- `id`, `version`, `name`
- `ux_invariants`:
  - command vocabulary (e.g., park/resume/status)
  - status strip format
  - memory promises (what is remembered, for how long)
- `defaults`:
  - default stance
  - default meaning altitude target
  - default risk posture
- `constraints`:
  - forbidden behaviors (e.g., “no task-manager nagging”)
  - escalation rules (when to push vs when to ask)

Deterministic shape (YAML/JSON-equivalent):

```yaml
PersonaProfile:
  id: string
  version: string
  name: string
  ux_invariants:
    commands: [string]
    status_strip: string
    memory_promises: [string]
  defaults:
    stance: string
    meaning_altitude: string
    risk_posture: low|medium|high
  constraints:
    forbidden_behaviors: [string]
    escalation_rules: [string]
```

### StackProfile (released unit)

Fields:
- `id`, `version`, `persona_profile_id`
- `modules`:
  - attention modules list (by module id)
  - ingestion modules list (by module id)
  - memory module id
- `capabilities`:
  - tool allowlist (read-only/none)
  - storage allowlist (what sources can be persisted)
- `risk_tier`: low | medium | high
- `routing_tags`: domains and task types

Deterministic shape (YAML/JSON-equivalent):

```yaml
StackProfile:
  id: string
  version: string
  persona_profile_id: string
  modules:
    attention: [string]   # module ids
    ingestion: [string]   # module ids
    memory: string        # module id
  capabilities:
    tools: none|read_only
    storage_allowlist: [string]
  risk_tier: low|medium|high
  routing_tags:
    domains: [string]
    task_types: [string]
```

## 3) Kernel outputs (what it may emit)

The kernel may emit:
- conversational responses (DoPeJar UX)
- **candidate briefs** (text-only) as inputs to Shaper
- append-only events/metrics (for evaluation)

The kernel must not emit:
- Control Plane commit artifacts (`08_commit.md`)
- executable commands intended for direct execution
- any “automatic commit” behavior

## 4) Ports (interfaces)

### MemoryPort

Required operations:
- `get_state()` → structured state
- `set_state(state)` → replace authoritative state (versioned)
- `append_event(event)` → append-only audit trail
- `query_events(filter)` → retrieval for review and debugging

Invariants:
- No silent drops; schema validation on write.
- Explicit retention policy applied to events and stored artifacts.

### IngestionPort

Required operations:
- `ingest(source_id, payload)` → list of `EvidenceItem`

EvidenceItem fields:
- `source_type` (email/doc/meeting_note/etc)
- `source_id`
- `captured_at` (optional; if present must be provided externally, not generated by kernel)
- `content` (text)
- `metadata` (sender, doc title, meeting date, etc.)

Invariants:
- Deterministic output for identical inputs.
- No action generation; only evidence.

### LLMPort (optional)

Required operations:
- `propose(prompt)` → proposal(s)

Invariants:
- Proposals are non-authoritative until accepted by kernel.
- Kernel must remain deterministic when LLM is absent (e.g., fallback prompts or manual mode).

## 5) Routing and orchestration

Routing has two levels:

1) **Persona selection** (sprint-managed)
   - Select active `PersonaProfile` version for the user.

2) **Task routing** (runtime selection from released stacks)
   - Based on task type (learn/write/finance/family/build) and risk tier.
   - Kernel chooses a `StackProfile` tagged for the task.

Rule: Task routing can switch stacks only at a boundary (pause/resume, session reset, or explicit transition).

## 6) Park/resume semantics (human continuity)

To preserve “human feel”:
- Interruption is normal and should not be treated as a failure.
- Kernel should support:
  - `park(current_focus)` → writes resumable pointer (what/why/next step)
  - `resume(focus_id)` → asks “what changed?” only at resume time

## 7) Control Plane handoff (non-conflating)

Kernel can generate a **candidate brief** (text-only) that is fed into Shaper as conversation input:
- objective
- why (north star link)
- suggested artifact altitude (L3 work item vs L4 spec)
- scope hints
- acceptance intent

Kernel must not generate `08_commit.md` or invoke Control Plane scripts.
